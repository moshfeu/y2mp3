env:
  global:
  - secure: jrWNRU16gQHPhbIYuT58HP8x+CLt/uQbdLYbma3SOjfpXntW1+N98hzr7edYNavqGFat2UsWj76YdL1IzahsO1PmZwEgvY1GxVKI49KalnaizZuzLewaY/S9IoU+xErVojUK5afXayrHCP4mbm/V/Vx4J8fXhIOeEWABaf+1zqLUavfKA7m5GPyzP7BAYLEbyDec9f1kVjs2WfxJVJTW5gNRr1JyTmLRv82pJZDnrZtHoa9cEaXRjz0H4Jm84dUEreaGbdOAd5D+AVJg4HiAGRTUWjw9pS3ygZzIx3VX6thEfSv3dcZsPixmIwnFbRuhdDlE0OUGiuoTNmh/MetyZy1znH+BmuIU2gOtfcITAKicdSd4ZCg1TjzNJVH+GPk6c9i3H4JuBwj6ctNonxqW5031MwnnH5UfUFFkURDh2TBr1S5WPCvxDkTRaYuWfTNM3SsQTVYylwQzq0mlCw2zVQVaOrrHDekclo1scek1vhNMDH6f8smAiET/6UG/zPRV5RNlbTM1sBvQ+fZ11DQmyXsmKW4mRKIPR316niuSIbdIEaRo5/99L+fsXZpzQuxykGCUi8gqFXPurZcBz718dUTUF0uJXWyu6iS8wtvz9xqxMGxFodNb/+nR/O5M2NJEuJaZhNOKOvVQexUdVC6Ox2w7RNSGwAeiJFteTsI2QLE=
matrix:
  include:
  - os: linux
    language: node_js
    node_js: '14'
    env:
    - ELECTRON_CACHE=$HOME/.cache/electron
    - ELECTRON_BUILDER_CACHE=$HOME/.cache/electron-builder
  - os: osx
    osx_image: xcode13.2
    language: node_js
    node_js: '14'
    env:
    - ELECTRON_CACHE=$HOME/.cache/electron
    - ELECTRON_BUILDER_CACHE=$HOME/.cache/electron-builder
cache:
  yarn: true
  directories:
  - "$HOME/.cache/electron"
  - "$HOME/.cache/electron-builder"
before_install:
- |
  if [ "$TRAVIS_OS_NAME" == "osx" ]; then
    mkdir -p /tmp/git-lfs && curl -L https://github.com/github/git-lfs/releases/download/v2.3.1/git-lfs-$([ "$TRAVIS_OS_NAME" == "linux" ] && echo "linux" || echo "darwin")-amd64-2.3.1.tar.gz | tar -xz -C /tmp/git-lfs --strip-components 1
    export PATH="/tmp/git-lfs:$PATH"
  fi
install:
- yarn
- yarn upgrade node-sass
- yarn generate-icons
before_script:
- git lfs pull
script:
- |
  yarn build
  yarn test
  ENVS=`env | grep -iE '^(DEBUG|NODE_|ELECTRON_|YARN_|NPM_|CI|CIRCLE|TRAVIS|APPVEYOR_|CSC_|_TOKEN|_KEY|AWS_|STRIP|BUILD_)([A-Z]|_)*=' | sed -n '/^[^\t]/s/=.*//p' | sed '/^$/d' | sed 's/^/-e /g' | tr '\n' ' '`
  if [ -n "$TRAVIS_TAG" ]; then
    echo '=== starting travis deploy ==='
    if [ "$TRAVIS_OS_NAME" == "linux" ]; then
      docker run $ENVS --rm \
        -v ${PWD}:/project \
        -v ~/.cache/electron:/root/.cache/electron \
        -v ~/.cache/electron-builder:/root/.cache/electron-builder \
        electronuserland/builder:wine \
        /bin/bash -c "yarn --link-duplicates --pure-lockfile && yarn dist --linux --win"
    else
      yarn dist
    fi
  fi
before_cache:
- rm -rf $HOME/.cache/electron-builder/wine
deploy:
  provider: releases
  api_key:
    secure: jrWNRU16gQHPhbIYuT58HP8x+CLt/uQbdLYbma3SOjfpXntW1+N98hzr7edYNavqGFat2UsWj76YdL1IzahsO1PmZwEgvY1GxVKI49KalnaizZuzLewaY/S9IoU+xErVojUK5afXayrHCP4mbm/V/Vx4J8fXhIOeEWABaf+1zqLUavfKA7m5GPyzP7BAYLEbyDec9f1kVjs2WfxJVJTW5gNRr1JyTmLRv82pJZDnrZtHoa9cEaXRjz0H4Jm84dUEreaGbdOAd5D+AVJg4HiAGRTUWjw9pS3ygZzIx3VX6thEfSv3dcZsPixmIwnFbRuhdDlE0OUGiuoTNmh/MetyZy1znH+BmuIU2gOtfcITAKicdSd4ZCg1TjzNJVH+GPk6c9i3H4JuBwj6ctNonxqW5031MwnnH5UfUFFkURDh2TBr1S5WPCvxDkTRaYuWfTNM3SsQTVYylwQzq0mlCw2zVQVaOrrHDekclo1scek1vhNMDH6f8smAiET/6UG/zPRV5RNlbTM1sBvQ+fZ11DQmyXsmKW4mRKIPR316niuSIbdIEaRo5/99L+fsXZpzQuxykGCUi8gqFXPurZcBz718dUTUF0uJXWyu6iS8wtvz9xqxMGxFodNb/+nR/O5M2NJEuJaZhNOKOvVQexUdVC6Ox2w7RNSGwAeiJFteTsI2QLE=
  file_glob: true
  file:
  - dist/*.dmg
  - dist/*.AppImage
  - dist/*.exe
  target_commitish: "$TRAVIS_COMMIT"
  tag_name: "$TRAVIS_TAG"
  overwrite: true
  skip_cleanup: true
  draft: false
  on:
    repo: moshfeu/y2mp3
    tags: true
